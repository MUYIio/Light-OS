# 2021操作系统大赛总决赛文档
2021全国大学生计算机系统能力大赛操作系统设计大赛，小骨头战队参与的操作系统比赛项目，开发一个可以在riscv64 k210开发板上可以运行的操作系统内核。
## 1. 比赛准备和调研
在参加比赛时，自己是做x86相关系统开发的，得知要开发riscv操作系统内核，于是便产生了兴趣。riscv是最近几年年才在中国火起来的处理器架构，这个架构是属于精简指令集，非常轻巧。由于xbook2内核只支持x86架构，于是便产生了将其移植到riscv64上面，于是这个项目便产生了。也就是xbook2-riscv64。通过官方给出的参考文档，发现了很多比较优秀的开源项目，于是，本项目就在那些项目的基础上进行了一定的延伸，例如rustsbi，xv6-riscv，xv6-k210等，在此对这些项目表示感谢。

## 2. 系统框架和模块设计
xbook2是一个宏内核的操作系统内核，支持多进程/线程，文件系统，网络，图形等功能。

在xbook2中，驱动框架使用了类windows驱动框架，文件系统使用了类vfs架构，网络使用了lwip协议栈作为实现。在k210中，目前支持了con控制台驱动，sd卡驱动，从而可以实现一个最小的操作系统内核的支持。

## 3. 开发计划
从初赛开始，主要做的事情就是让内核跑起来，并且可以执行应用程序，这个过程主要是参考了xv6-k210的实现，将其底层比较好的地方移植进来，从而实现了内核的运行。后面就是对测试案例的支持，于是需要实现应用程序的支持，在支持后，就可以添加系统调用的支持，通过测试案例。

从进入决赛后，就可以实现运行用户程序了，于是进入决赛后，需要做的就是对musl库的适配，以及应用程序的移植。然而，这个过程并不简单，在进行长久的尝试后，没有得出比较好的结果，于是采取了xbook2内核自己对应的xlibc，实现的比较简单，但是依然可以执行一些应用程序。

## 4. 重要进展
1. 成功启动rustsbi，意义类似于hello，world和点灯。
2. 成功显示hello，xbook2，意味着能够进入内核。
3. 切换多任务成功，说明任务切换也没问题。
4. 成功移植SD卡驱动，说明文件系统不远了。
5. 成功执行第一个应用程序，说明和内核接口已经打通。

## 5. 遇到的问题以及解决方案
1. 开发板不会使用。

    解决：在群里面提问，老师和同学帮助解决。

2. 编译程序不通过。

    解决：工具链使用错误，更换官方提供的工具链即可，

3. 时钟中断没能产生。
    
    解决：忘记打开时钟中断屏蔽了，打开即可。

4. 多任务调度带来的线程栈炸裂

    解决：栈开大一点就好了，毕竟是64位了。

5. 文件系统不能正确识别远程测试机中的文件。

    解决：强制烧写为fat32即可，不然会因为3M磁盘大小解析为fat16。

6. 应用程序用户态执行出错

    解决：objdump返汇编调试，根据epc查找bug。

7. 执行lua时出现浮点异常
    
    解决：rustsbi没有自动打开浮点支持，手动打开浮点支持即可。

8. 直接执行总决赛官方给出的程序报错。

    解决：尚未解决，使用的是自己编译的应用程序。

## 6. 作品特征描述
1. xbook2-riscv64是一个内核功能丰富的操作系统内核，支持fatfs,devfs等文件系统。
2. xbook2-riscv64采用了许多自己研发的机制，比如fsal，memnode内存管理，时间片+优先级的分时调度算法。
3. xbook2-riscv64支持QEMU虚拟机和k210开发板运行，
4. 支持sd卡驱动和virtio磁盘驱动。

## 7. 分工与协作
由于该项目只有我一个人参与，所以所有的事情都是一个人开发的。

## 8. 目录描述

| 目录            | 描述                                      |
| ------------- | --------------------------------------- |
| develop       | 开发时用到的磁盘镜像，ROM文件系统内容等   |
| doc           | 操作系统相关的文档                               |
| scripts       | 用到的xbuild脚本和其它配置文件 |
| src           | xbook2内核的源码                  |
| src/arch/riscv64           | riscv64处理器线管代码                  |
| tools         | 内核开发需要用到的工具                         |
| bin           | 命令行可执行程序  |
| sbin          | 系统使用的程序  |
| libs          | 用户态库  |

## 9. 比赛收获

本次比赛，从无到有，实现了riscv处理器的操作系统，还是非常兴奋的。在漫长的开发过程中，深刻理解到了对硬件理解透彻的重要性，知己知彼，百战不殆。这个过程学到了很多新的知识，掌握了许多新的技能，自己得到了很大的提升。除此之外，还认识了许多老师和许多大佬，西安邮电大学的陈莉君老师给了我很大的帮助，在我迷茫的时候为我指定方向，重庆师范大学的贺一老师也为我参与比赛高兴，给我加油打气。车春池同学在我遇到k210问题时进行解答，洛佳同学在我遇到rustsbi问题时即使出手，李志锐同学也给了我很大帮助。还有其它很多的老师和同学也给了我很多的帮助，鼓励与支持，在此表示感谢！

这次比赛，让我认识到了我和别人的差距，作为非科班出生的我，在和他们一起参加比赛的时候，发现他们的解决问题能力以及表达能力都是比较强的，这方面我还有待提升，还要进行更多的学习才能变得更巧。

最后，祝愿自己能在决赛中取得好的成绩，也祝愿操作系统大赛以后办的更好，培养更多操作系统方面的人才，为祖国的操作系统事业发展培养人才，让他们成为国内操作系统行业的顶梁柱！